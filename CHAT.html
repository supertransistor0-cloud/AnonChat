<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Crypto Chat + –§–∞–π–ª—ã</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --bg-color: #222222;
            --container-bg: #bbbbee;
            --accent-color: #ff4444;
            --text-color: #ffffff;
            --border-color: #dddddd;
        }

        body { 
            background: var(--bg-color); 
            color: var(--text-color); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; 
            display: flex; 
            justify-content: center;
            height: 100vh;
        }

        .container { 
            width: 100%; 
            max-width: 500px; 
            background: var(--container-bg); 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }

        #login-screen {
            padding: 40px 20px;
            justify-content: center;
            align-items: center;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
        }

        input { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            background: #20262d; 
            border: 1px solid var(--border-color); 
            color: white; 
            border-radius: 10px; 
            font-size: 16px;
            outline: none;
        }

        input:focus { border-color: var(--accent-color); }

        button { 
            width: 100%; 
            padding: 15px; 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:active { opacity: 0.7; }

        #chat-screen { 
            display: none; 
            flex-direction: column; 
            height: 100vh; 
        }

        .header {
            padding: 15px;
            background: #9999ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(7,7,7,0.3);
        }

        #messages { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
        }

        .msg-item { 
            background: #9999ff; 
            padding: 10px 15px; 
            border-radius: 10px; 
            max-width: 85%; 
            word-wrap: break-word;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        .file-message {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-link {
            background: #00a884;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
        }
        .input-area {
            padding: 10px;
            background: #20262d;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #msgInput { margin: 0; flex-grow: 1; }
        .send-btn { width: auto; padding: 12px 20px; }
        .attach-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
            width: auto;
            color: var(--accent-color);
        }
    </style>
</head>
<body>

<div id="login-screen">
    <h3 style="margin-bottom: 30px;">üîê Anon Chat —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ñ–∞–π–ª–æ–≤ –∏ –∫–æ–Ω—Å–æ–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏</h3>
    <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è">
    <input type="password" id="seedPhrase" placeholder="–°–∏–¥-—Ñ—Ä–∞–∑–∞">
    <button onclick="enterChat()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
</div>

<div id="chat-screen">
    <div class="header">
        <span id="display-name" style="font-weight: bold;"></span>
        <button onclick="loadMessages()" style="width:auto; padding: 5px 10px; font-size: 12px; background: #30363d;">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    
    <div id="messages"></div>

    <div class="input-area">
        <input type="file" id="fileInput" style="display:none;">
        <button class="attach-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
        <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
    </div>
</div>

<script>
    // –°–¥–µ—Å—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    var GITHUB_TOKEN = ''; // GitHub —Ç–æ–∫–µ–Ω
    var GIST_ID = ''; // Gist ID
    var FILE_NAME = 'chat.txt'; // –§–∞–π–ª

    let currentUser = '';
    let currentSeed = '';

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
    function set_id_a_token(token, id) {
        GITHUB_TOKEN = token;
        GIST_ID = id;
    }

    // –í—Ö–æ–¥ –≤ —á–∞—Ç
    function enterChat() {
        currentUser = document.getElementById('userName').value.trim();
        currentSeed = document.getElementById('seedPhrase').value.trim();

        if (!currentUser || !currentSeed) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Å–∏–¥-—Ñ—Ä–∞–∑—É!");

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('display-name').innerText = currentUser;
        
        loadMessages();
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function sendMessage() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if (!text) return;

        const fullMessage = `${currentUser}: ${text}`; // –ü–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const encrypted = CryptoJS.AES.encrypt(fullMessage, currentSeed).toString(); // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ

        input.value = '';
        await postEncryptedMessage(encrypted);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
    function sendFile() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 5 –ú–ë (GitHub Gist –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç—ã)
        if (file.size > 5 * 1024 * 1024) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 5 –ú–ë)');
            fileInput.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = async function(e) {
            // –ü–æ–ª—É—á–∞–µ–º base64 –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ data:*/*;base64,
            const base64Data = e.target.result.split(',')[1];
            
            const fileObject = {
                type: 'file',
                name: file.name,
                mime: file.type || 'application/octet-stream',
                size: file.size,
                data: base64Data
            };

            const jsonStr = JSON.stringify(fileObject);
            const encrypted = CryptoJS.AES.encrypt(jsonStr, currentSeed).toString();

            fileInput.value = ''; // —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
            await postEncryptedMessage(encrypted);
        };
        reader.readAsDataURL(file);
    }

    // –û–±—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ Gist
    async function postEncryptedMessage(encryptedText) {
        try {
            const getResp = await fetch(`https://api.github.com/gists/${GIST_ID}`);
            const getData = await getResp.json();
            const oldContent = getData.files[FILE_NAME].content;
            const newContent = oldContent + (oldContent ? '\n' : '') + encryptedText;

            await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: { [FILE_NAME]: { content: newContent } }
                })
            });
            loadMessages(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ'); // –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    async function loadMessages() {
        const msgDiv = document.getElementById('messages');
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}?t=${Date.now()}`);
            const data = await response.json();
            const content = data.files[FILE_NAME].content;
            
            const lines = content.split('\n');
            msgDiv.innerHTML = '';

            for (let line of lines) {
                if (!line.trim()) continue;
                try {
                    const bytes = CryptoJS.AES.decrypt(line, currentSeed);
                    const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                    if (decrypted) {
                        displayMessage(decrypted, msgDiv);
                    }
                } catch (e) {
                    console.log("–ù–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–ª–æ—Å—å")
                }
            }
            msgDiv.scrollTop = msgDiv.scrollHeight;
        } catch (err) {
            msgDiv.innerHTML = '<center>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</center>';
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–∞–π–ª)
    function displayMessage(decryptedText, container) {
        const msgDiv = document.createElement('div'); // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        msgDiv.className = 'msg-item';

        // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON-—Ñ–∞–π–ª
        try {
            const parsed = JSON.parse(decryptedText);
            if (parsed.type === 'file' && parsed.name && parsed.data) {
                // –≠—Ç–æ —Ñ–∞–π–ª
                const fileName = parsed.name;
                const fileSize = formatSize(parsed.size);
                const mime = parsed.mime;
                const base64Data = parsed.data;

                // –°–æ–∑–¥–∞—ë–º Blob –∏ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É
                const binary = atob(base64Data);
                const array = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    array[i] = binary.charCodeAt(i);
                }
                const blob = new Blob([array], { type: mime });
                const url = URL.createObjectURL(blob);

                // –û—Ç–ø—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–ª–æ—Ö–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
                msgDiv.innerHTML = `
                    <div class="file-message"> 
                        <span>üìé ${fileName} (${fileSize})</span>
                        <a href="${url}" download="${fileName.replace(/["']/g, '_')}" class="file-link">–°–∫–∞—á–∞—Ç—å</a>
                    </div>
                `;
                // —Å—Å—ã–ª–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–º–æ–∂–Ω–æ –Ω–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å—Å—è)
            } else {
                // JSON, –Ω–æ –Ω–µ –Ω–∞—à —Ñ–æ—Ä–º–∞—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
                msgDiv.textContent = decryptedText;
            }
        } catch {
            // –ù–µ JSON ‚Äî –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            msgDiv.textContent = decryptedText;
        }

        container.appendChild(msgDiv);
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.getElementById('msgInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });

    document.getElementById('fileInput').addEventListener('change', sendFile);
</script>
</body>
</html>